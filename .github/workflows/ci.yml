name: CI/CD Docker Pipeline

on:
  push:
    branches:
      - development
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: counter-app

###############################################################################
# JOB 1: BUILD + PUSH + NON-BLOCKING SECURITY SCANS (CI)
###############################################################################
jobs:
  build-and-push:
    name: Build & Push (CI)
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'development' || 'development' }}

    outputs:
      image_tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #########################################################################
      # VERSIONING
      #########################################################################
      - name: Determine Next Version
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_TAG="v0.0.1"
          else
            NEXT_TAG=$(echo "$LATEST_TAG" | sed 's/v//' | awk -F. '{printf "v%d.%d.%d", $1,$2,$3+1}')
          fi
          echo "tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT_TAG"

      #########################################################################
      # AWS AUTH (OIDC)
      #########################################################################
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY

      #########################################################################
      # BUILD + TAG IMAGE
      #########################################################################
      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build \
            -t counter-app:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

      - name: Push Docker image to ECR
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      #########################################################################
      # RELEASE (NON-BLOCKING)
      #########################################################################
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          generate_release_notes: true

      #########################################################################
      # SONAR (NON-BLOCKING)
      #########################################################################
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #########################################################################
      # SNYK (NON-BLOCKING CI SCAN)
      #########################################################################
      - name: Snyk Scan (CI Non-blocking)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: counter-app:${{ steps.version.outputs.tag }}
          args: --severity-threshold=critical
        continue-on-error: true

###############################################################################
# JOB 2: PRODUCTION DEPLOY GATE (BLOCKING)
###############################################################################
  deploy-production:
    name: Production Security Gate
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: production   # â¬… requires manual approval

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull image for production scan
        run: |
          docker pull ${{ steps.login-ecr.outputs.registry }}/counter-app:${{ needs.build-and-push.outputs.image_tag }}

########################################################
# ðŸ”’ PRODUCTION SNYK GATE (BLOCKING).               ####
########################################################
      - name: Snyk Scan (Production Gate)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ steps.login-ecr.outputs.registry }}/counter-app:${{ needs.build-and-push.outputs.image_tag }}
          args: --severity-threshold=critical
        continue-on-error: false

###########################################################
###         PUSH IMAGE TO ECR AND DEPLOY TO EC2         ###
###     Tag Docker image as "latest" and push to ECR    ###
###               Deploy to EC2 using SSH               ###
###########################################################

      - name: Push Docker image to ECR and Deploy to EC2
        env:
         ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
         ECR_REPOSITORY: counter-app
         IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
           docker tag counter-app:${{ needs.build-and-push.outputs.image_tag }} ${{ steps.login-ecr.outputs.registry }}/counter-app:latest
           docker push ${{ steps.login-ecr.outputs.registry }}/counter-app:latest

      - name: Deploy to EC2 via SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_PEM_KEY: ${{ secrets.EC2_PEM_KEY }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: counter-app
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          echo "$EC2_PEM_KEY" > ec2.pem
          chmod 400 ec2.pem

          # SSH SCP COMMANDS

          SSH_COMMANDS="ssh -i ec2.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST"
          SCP_COMMANDS="scp -i ec2.pem -o StrictHostKeyChecking=no"

          # Login to docker registry

          $SSH_COMMANDS "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_REGISTRY"
          $SCP_COMMANDS docker-compose.yml $EC2_USER@$EC2_HOST:/home/ubuntu/docker

          # Pull and run the new docker image
          
          $SSH_COMMANDS "cd /home/ubuntu/docker && docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG && docker composse -f docker-compose.yml up -d --force-recreate"

          # CLEANUP
          rm -f ec2.pem
