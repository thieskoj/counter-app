name: CI/CD Docker Pipeline

permissions:
  contents: write
  id-token: write

# Run on pushes to dev or main
on:
  push:
    branches:
      - development
      - main
  workflow_dispatch: # manual trigger

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Determine next version
      - name: Determine Next Version
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_TAG="v0.0.1"
          else
            NEXT_TAG=$(echo "$LATEST_TAG" | sed 's/v//' | awk -F. '{printf "v%d.%d.%d", $1,$2,$3+1}')
          fi
          echo "tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT_TAG"

      # 3️⃣ Configure AWS via OIDC (no static keys)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: us-east-1

      # 4️⃣ Login to ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 5️⃣ Ensure ECR repository exists
      - name: Ensure ECR Repository Exists
        run: |
          aws ecr describe-repositories --repository-names counter-app || \
          aws ecr create-repository --repository-name counter-app

      # 6️⃣ Build Docker image
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: counter-app
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
         docker build \
            -t counter-app:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .     
            
      # 7️⃣ Push Docker image
      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: counter-app
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # 8️⃣ Create GitHub release (only on main)
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          draft: false
          prerelease: false

################################################################
###               SONAR CLOUD SCAN                           ###
### Drops the build if any bugs or vulnerabilities are found.###
###            Using the default quality gate.               ###
###        Connected to my personal Sonar Cloud account      ###
################################################################

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git for SonarCloud
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"


###########################################################
###  Docker image Snyk scan | If fails, drop the action ###

###########################################################

      - name: Debug Docker images
        run: docker images

      - name: Scan Docker image with Snyk for vulnerabilities
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: counter-app:${{ steps.version.outputs.tag }}
          args: --severity-threshold=high
        continue-on-error: false
