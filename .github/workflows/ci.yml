name: CI/CD Docker Pipeline

on:
  push:
    branches:
      - development
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: counter-app
  ECR_REGISTRY: 970547342192.dkr.ecr.us-east-1.amazonaws.com

###############################################################################
# JOB 1: BUILD + PUSH (CI)
###############################################################################
jobs:
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #########################################################################
      # VERSIONING
      #########################################################################
      - name: Determine Next Version
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_TAG="v0.0.1"
          else
            NEXT_TAG=$(echo "$LATEST_TAG" | sed 's/v//' | awk -F. '{printf "v%d.%d.%d", $1,$2,$3+1}')
          fi
          echo "tag=$NEXT_TAG" >> $GITHUB_OUTPUT

      #########################################################################
      # AWS AUTH
      #########################################################################
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY

      #########################################################################
      # BUILD + PUSH
      #########################################################################
      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

      - name: Push Docker image to ECR
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

###############################################################################
# JOB 2: AUTO DEPLOY TO DEVELOPMENT
###############################################################################
  deploy-development:
    name: Deploy to Development EC2
    if: github.ref == 'refs/heads/development'
    needs: build-and-push
    runs-on: ubuntu-latest

    environment: development

    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_PEM_KEY }}" > ec2.pem
          chmod 400 ec2.pem

      - name: Deploy to DEV EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          SSH="ssh -i ec2.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST"
          SCP="scp -i ec2.pem -o StrictHostKeyChecking=no"

          $SCP docker-compose.yml $EC2_USER@$EC2_HOST:/home/ubuntu/docker-compose.yml

          $SSH << EOF
            aws ecr get-login-password --region us-east-1 \
              | docker login --username AWS --password-stdin $ECR_REGISTRY

            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker compose -f ~/docker-compose.yml up -d --force-recreate
          EOF

      - name: Cleanup SSH key
        run: rm -f ec2.pem

###############################################################################
# JOB 3: PRODUCTION SECURITY GATE + MANUAL APPROVAL
###############################################################################
  deploy-production:
    name: Production Approval + Security Gate
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest

    environment:
      name: production

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull image for production scan
        run: |
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:${{ needs.build-and-push.outputs.image_tag }}

      - name: Snyk Scan (Production Gate)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: $ECR_REGISTRY/$ECR_REPOSITORY:${{ needs.build-and-push.outputs.image_tag }}
          args: --severity-threshold=critical

###############################################################################
# JOB 4: DEPLOY TO PRODUCTION EC2
###############################################################################
  deploy-ec2:
    name: Deploy to Production EC2
    needs: deploy-production
    runs-on: ubuntu-latest

    environment: production

    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_PEM_KEY }}" > ec2.pem
          chmod 400 ec2.pem

      - name: Deploy to PROD EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          SSH="ssh -i ec2.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST"
          SCP="scp -i ec2.pem -o StrictHostKeyChecking=no"

          $SCP docker-compose.yml $EC2_USER@$EC2_HOST:/home/ubuntu/docker-compose.yml

          $SSH << EOF
            aws ecr get-login-password --region us-east-1 \
              | docker login --username AWS --password-stdin $ECR_REGISTRY

            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker compose -f ~/docker-compose.yml up -d --force-recreate
          EOF

      - name: Cleanup SSH key
        run: rm -f ec2.pem
