name: CI/CD Docker Pipeline

on:
  push:
    branches:
      - development
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 970547342192
  ECR_REPOSITORY: counter-app
  ECR_REGISTRY: 970547342192.dkr.ecr.us-east-1.amazonaws.com

###############################################################################
# JOB 1: BUILD + PUSH + NON-BLOCKING SECURITY SCANS (CI)
###############################################################################
jobs:
  build-and-push:
    name: Build & Push (CI)
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.version.outputs.tag }}

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #########################################################################
      # VERSIONING
      #########################################################################
      - name: Determine Next Version
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_TAG="v0.0.1"
          else
            NEXT_TAG=$(echo "$LATEST_TAG" | sed 's/v//' | awk -F. '{printf "v%d.%d.%d", $1,$2,$3+1}')
          fi
          echo "tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT_TAG"

      #########################################################################
      # AWS AUTH (OIDC)
      #########################################################################
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY

      #########################################################################
      # BUILD + TAG + PUSH
      #########################################################################
      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

      - name: Push Docker image to ECR
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      #########################################################################
      # SANITY CHECK (FAIL FAST)
      #########################################################################
      - name: Sanity check image tag
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          if [ -z "$IMAGE_TAG" ]; then
            echo "‚ùå IMAGE_TAG is empty. Aborting."
            exit 1
          fi
          echo "‚úÖ Image tag is $IMAGE_TAG"

      #########################################################################
      # VERIFY IMAGE EXISTS IN ECR
      #########################################################################
      - name: Verify image exists in ECR
        env:
          IMAGE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --image-ids imageTag=$IMAGE_TAG

      #########################################################################
      # NON-BLOCKING SECURITY SCANS (CI)
      #########################################################################
      - name: SonarCloud Scan (CI)
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Snyk Scan (CI non-blocking)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.version.outputs.tag }}
          args: --severity-threshold=critical
        continue-on-error: true

      #########################################################################
      # RELEASE (ONLY ON MAIN)
      #########################################################################
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          generate_release_notes: true

###############################################################################
# JOB 2: PRODUCTION SECURITY GATE (BLOCKING + MANUAL APPROVAL)
###############################################################################
  deploy-production:
    name: Production Security Gate
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest

    environment:
      name: production   # ‚¨Ö requires manual approval

    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::970547342192:role/github_actions_OIDC_role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      #########################################################################
      # SANITY CHECK (PRODUCTION)
      #########################################################################
      - name: Sanity check production image reference
        run: |
          if [ -z "$IMAGE_TAG" ]; then
            echo "‚ùå IMAGE_TAG is empty"
            exit 1
          fi
          echo "‚úÖ Scanning $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Pull image for production scan
        run: |
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      #########################################################################
      # üîí BLOCKING PRODUCTION SNYK GATE
      #########################################################################
      - name: Snyk Scan (Production blocking)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          args: --severity-threshold=critical
        continue-on-error: false
